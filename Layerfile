# Use Ubuntu 18.04 as the base image
FROM vm/ubuntu:18.04

# Install Node.js (using a more recent version)
RUN curl -sL https://deb.nodesource.com/setup_14.x | bash && \
    apt install nodejs && \
    rm -f /etc/apt/sources.list.d/nodesource.list

# Debug: Print Node.js and npm versions
RUN node -v && npm -v

# Copy the entire project directory
COPY . .

# Debug: List directory contents
RUN ls -la

# Debug: Show contents of package.json
RUN cat package.json

# Install project dependencies
RUN npm install

# Create .env file with environment variables (if not already present)
RUN if [ ! -f .env ]; then \
    echo "OPENWEATHERMAP_API_KEY=your_openweathermap_api_key_here" > .env && \
    echo "MAPBOX_TOKEN=your_mapbox_token_here" >> .env; \
    fi

# Debug: List installed packages
RUN npm list --depth=0

# Debug: Show contents of bin/www
RUN cat bin/www

# Debug: Show contents of app.js
RUN cat app.js

# Install nodemon globally
RUN npm install -g nodemon

# Start the Express server in the background and redirect output to a log file
RUN BACKGROUND nodemon ./bin/www > server.log 2>&1

# Wait for a moment to allow the server to start
RUN sleep 10

# Debug: Display the server log
RUN cat server.log

# Debug: Check if the process is running and listening on port 3000
RUN netstat -tulpn | grep :3000 || echo "No process found listening on port 3000"

# Expose the application
EXPOSE WEBSITE http://localhost:3000