FROM vm/ubuntu:18.04

# Install Node.js (latest LTS version for compatibility)
RUN curl -sL https://deb.nodesource.com/setup_18.x | bash
RUN apt-get install -y nodejs

# Debug: Print Node.js and npm versions
RUN node -v && npm -v

COPY . .

# Install dependencies
RUN npm ci

# Set the environment variables as secrets
SECRET ENV OPENWEATHERMAP_API_KEY
SECRET ENV MAPBOX_TOKEN

# Verify the API keys are set (this will not print the actual keys)
RUN echo "OpenWeatherMap API Key is set: $([[ -n $OPENWEATHERMAP_API_KEY ]] && echo 'Yes' || echo 'No')"
RUN echo "Mapbox Token is set: $([[ -n $MAPBOX_TOKEN ]] && echo 'Yes' || echo 'No')"

# Debug: Show contents of package.json
RUN cat package.json

# Debug: List directory contents
RUN ls -la

# Debug: Show contents of bin/www
RUN cat bin/www

# Start the Express server in the background
RUN BACKGROUND npm start

# Wait for a moment to allow the server to start
RUN sleep 10

# Debug: Check if the process is running and listening on port 3000
RUN netstat -tulpn | grep :3000 || echo "No process found listening on port 3000"

# If the server isn't running, display the logs
RUN if ! netstat -tulpn | grep :3000; then cat *.log; fi

EXPOSE WEBSITE http://localhost:3000